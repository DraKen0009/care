# Generated by Django 4.2.10 on 2024-03-04 16:27
import json

from django.core.exceptions import ObjectDoesNotExist
from django.db import migrations


def set_static_id(apps, schema_editor):
    MedibaseMedicine = apps.get_model("facility", "MedibaseMedicine")
    Prescription = apps.get_model("facility", "Prescription")

    if MedibaseMedicine.objects.count() == 0:
        return

    with open("data/medibase.json", "r") as f:
        data = json.load(f)

    for medicine in data:
        try:
            m = MedibaseMedicine.objects.get(name=medicine["name"])
        except ObjectDoesNotExist:
            m = MedibaseMedicine.objects.create(
                id=medicine["id"],
                name=medicine["name"],
                type=medicine["type"],
                company=medicine.get("company"),
                contents=medicine.get("contents"),
                cims_class=medicine.get("cims_class"),
                atc_classification=medicine.get("atc_classification"),
                generic=medicine.get("generic"),
            )
        else:
            MedibaseMedicine.objects.filter(name=medicine["name"]).update(id=medicine["id"])

        Prescription.objects.filter(medicine_id=m.id).update(medicine_id=medicine["id"])


class Migration(migrations.Migration):
    dependencies = [
        ("facility", "0415_remove_medibasemedicine_external_id_and_more"),
    ]

    operations = [
        migrations.RunSQL(
            """
            -- Update foreign key references in facility_prescription table
            UPDATE facility_prescription
            SET medicine_id = medicine_id + 100000
            WHERE medicine_id IN (
                SELECT id
                FROM facility_medibasemedicine
            )
            """
        ),
        migrations.RunSQL(
            """
            -- Update the id column in facility_medibasemedicine table
            UPDATE facility_medibasemedicine
            SET id = id + 100000
            """
        ),
        migrations.RunPython(
            set_static_id,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
